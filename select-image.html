<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Veldu myndina</title>
  <style id="dynamic-theme-style">
    body { font-family: Arial, sans-serif; background: #f7f7f7; margin: 0; padding: 0; }
    .container { max-width: 500px; margin: 40px auto; background: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: relative; }
    .counter { position: absolute; top: 24px; right: 32px; font-size: 1.1rem; color: #555; font-weight: bold; }
    h1 { margin-bottom: 24px; }
    .name-to-guess-section {
      background: #eaf4fb;
      border-radius: 12px;
      padding: 32px 0 24px 0;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .name-to-guess {
      font-size: 2.2rem;
      font-weight: bold;
      color: #0074d9;
      letter-spacing: 1px;
      text-align: center;
    }
    .choices { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px; }
    .choice-img-btn { background: none; border: 4px solid transparent; border-radius: 12px; padding: 0; cursor: pointer; transition: border 0.2s; }
    .choice-img-btn.correct { border-color: #2ecc40; }
    .choice-img-btn.incorrect { border-color: #ff4136; }
    .choice-img-btn.incorrect-overlay {
      position: relative;
    }
    .choice-img-btn.incorrect-overlay::after {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255, 65, 54, 0.55);
      border-radius: 8px;
      z-index: 1;
      pointer-events: none;
    }
    .wrong-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #fff;
      font-size: 1.1rem;
      font-weight: bold;
      text-shadow: 0 2px 8px rgba(0,0,0,0.25);
      z-index: 2;
      pointer-events: none;
      padding: 4px 12px;
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.85);
    }
    .choice-img { width: 100%; max-width: 180px; height: auto; border-radius: 8px; display: block; margin: 0 auto; }
    .result { font-weight: bold; margin-top: 16px; text-align: center; }
    .back-link { display: block; margin-top: 24px; text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <span class="counter" id="counter"></span>
    <h1 id="quiz-title">...</h1>
    <div id="quiz-area">
      <div class="name-to-guess-section">
        <div class="name-to-guess" id="name-to-guess"></div>
      </div>
      <div class="choices" id="choices"></div>
      <div class="result" id="result"></div>
    </div>
    <a class="back-link" id="back-link" href="index.html"></a>
  </div>
  <script>
    let items = [];
    const QUESTION_COUNT = 10;
    let questionOrder = [];
    let questionNumber = 1;
    let score = 0;
    let categoryConfig = {};
    let category = 'brawlstars';

    function applyThemeColor(themeColor) {
      if (!themeColor) return;
      const style = document.getElementById('dynamic-theme-style');
      style.innerHTML = style.innerHTML.replace(/#0074d9/g, themeColor);
    }

    function getCategoryFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('category') || 'brawlstars';
    }
    category = getCategoryFromUrl();
    fetch('categories.json')
      .then(response => response.json())
      .then(categories => {
        categoryConfig = categories[category] || {};
        if (categoryConfig.themeColor) {
          applyThemeColor(categoryConfig.themeColor);
        }
        document.getElementById('quiz-title').textContent = categoryConfig.selectImageQuizTitle || 'Veldu myndina';
        document.getElementById('back-link').textContent = '← ' + (categoryConfig.backLink || 'Til baka í val á spurningakeppni');
        document.getElementById('back-link').href = 'index.html';
        // Use the key to determine the data file
        let dataFile = category + '.json';
        fetch(dataFile)
          .then(response => response.json())
          .then(data => {
            items = data;
            restartQuiz();
          })
          .catch(err => {
            document.getElementById('quiz-area').innerHTML = '<p>Tókst ekki að hlaða inn gögnum fyrir keppni.</p>';
          });
      });

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function getRandomChoices(correctIdx) {
      const choices = [items[correctIdx]];
      const used = new Set([correctIdx]);
      while (choices.length < 4) {
        const idx = Math.floor(Math.random() * items.length);
        if (!used.has(idx)) {
          choices.push(items[idx]);
          used.add(idx);
        }
      }
      return shuffle(choices);
    }

    function showCounter() {
      document.getElementById('counter').textContent = questionNumber + '/' + QUESTION_COUNT;
    }

    function showQuestion() {
      if (items.length === 0) return;
      showCounter();
      document.getElementById('result').textContent = '';
      const correctIdx = questionOrder[questionNumber-1];
      document.getElementById('name-to-guess').textContent = items[correctIdx].name;
      const choices = getRandomChoices(correctIdx);
      const choicesDiv = document.getElementById('choices');
      choicesDiv.innerHTML = '';
      choices.forEach(choice => {
        const btn = document.createElement('button');
        btn.className = 'choice-img-btn';
        btn.innerHTML = `<img src="${choice.img}" alt="${categoryConfig.imgAlt || ''}" class="choice-img" />`;
        btn.onclick = () => checkAnswer(choice.name, btn, choicesDiv, items[correctIdx].name);
        choicesDiv.appendChild(btn);
      });
      // Remove focus from all buttons after rendering
      setTimeout(() => {
        const active = document.activeElement;
        if (active && active.tagName === 'BUTTON' && active.classList.contains('choice-img-btn')) {
          active.blur();
        }
      }, 0);
    }

    function showSummary() {
      document.getElementById('quiz-area').innerHTML =
        `<div style='text-align:center;'>\n<h2>Keppni lokið!</h2>\n<p>Þú fékkst <strong>${score}</strong> af <strong>${QUESTION_COUNT}</strong> rétt.</p>\n<button onclick='restartQuiz()' style='padding:12px 24px;font-size:1.1rem;border-radius:8px;background:#0074d9;color:#fff;border:none;cursor:pointer;'>Byrja aftur</button>\n</div>`;
      document.getElementById('counter').textContent = '';
    }

    function checkAnswer(selectedName, btn, choicesDiv, correctName) {
      const buttons = choicesDiv.querySelectorAll('button');
      // Disable all buttons
      buttons.forEach(b => b.disabled = true);
      if (selectedName === correctName) {
        btn.classList.add('correct');
        document.getElementById('result').textContent = 'Rétt!';
        score++;
      } else {
        btn.classList.add('incorrect');
        btn.classList.add('incorrect-overlay');
        // Add overlay label with wrong name
        const label = document.createElement('span');
        label.className = 'wrong-label';
        label.textContent = selectedName;
        btn.appendChild(label);
        document.getElementById('result').textContent = 'Rangt!';
        // Highlight the correct image
        const correctItem = items.find(i => i.name === correctName);
        buttons.forEach(b => {
          const img = b.querySelector('img');
          // Use endsWith to avoid issues with absolute/relative src
          if (img && img.src.endsWith(correctItem.img)) {
            b.classList.add('correct');
          }
        });
      }
      setTimeout(() => {
        questionNumber++;
        if (questionNumber > QUESTION_COUNT) {
          showSummary();
        } else {
          showQuestion();
        }
      }, 3000);
    }

    function restartQuiz() {
      questionOrder = shuffle([...Array(items.length).keys()]).slice(0, QUESTION_COUNT);
      questionNumber = 1;
      score = 0;
      document.getElementById('quiz-area').innerHTML =
        `<div class=\"name-to-guess-section\"><div class=\"name-to-guess\" id=\"name-to-guess\"></div></div>\n<div class=\"choices\" id=\"choices\"></div>\n<div class=\"result\" id=\"result\"></div>`;
      showQuestion();
    }

    document.addEventListener('DOMContentLoaded', function() {
      category = getCategoryFromUrl();
      fetch('categories.json')
        .then(response => response.json())
        .then(categories => {
          categoryConfig = categories[category] || {};
          if (categoryConfig.themeColor) {
            applyThemeColor(categoryConfig.themeColor);
          }
          document.getElementById('quiz-title').textContent = categoryConfig.selectImageQuizTitle || 'Veldu myndina';
          document.getElementById('back-link').textContent = '← ' + (categoryConfig.backLink || 'Til baka í val á spurningakeppni');
          document.getElementById('back-link').href = 'index.html';
          // Use the key to determine the data file
          let dataFile = category + '.json';
          fetch(dataFile)
            .then(response => response.json())
            .then(data => {
              items = data;
              restartQuiz();
            })
            .catch(err => {
              document.getElementById('quiz-area').innerHTML = '<p>Tókst ekki að hlaða inn gögnum fyrir keppni.</p>';
            });
        });
    });
  </script>
</body>
</html>
